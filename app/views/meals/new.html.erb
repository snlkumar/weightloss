<!-- Tracking Show -->
<div class="full">
  <div class="grid_12">
    <h3>Hey <%= current_user.first_name %>, what did you eat?</h3>
    
    <% form_tag "/meals/meal_item", :id => 'meal-new-item' do %>
      <%= hidden_field_tag :food_id, "" %>
      <div id="meal-entry">
        <table>
          <tbody>
            <tr>
              <td class="food_name"><%= label_tag 'Food' %></td>
              <td class="food_amt"><%= label_tag 'Serving Amount' %></td>
              <td class="foot_measure"><%= label_tag 'Measure' %></td>
            </tr>
            <tr>
              <td><%= text_field_tag :food, "", :id => 'food-item-entry', :title => "Try one or more keywords" %></td>
              <td>
                <%= select_tag :quantity_whole, options_for_select(Meal::QUANTITY_WHOLE), :id => 'quantity-whole-entry' %>
                <%= select_tag :quantity_part,  options_for_select(Meal::QUANTITY_PARTS), :id => 'quantity-part-entry' %>
              </td>
              <td><%= select_tag :unit, options_for_select(Meal::UNITS), :id => 'unit-entry' %></td>
            </tr>
          </tbody>
        </table>
      <% end %>
      
      <% form_for @meal, :html => {:id => 'meal'} do |meal_form| %>
        <table>
          <tbody id="meal-items">
            <% meal_form.fields_for :meal_items do |meal_item_form| %>
              <%= render :partial => 'meal_items/meal_item_fields', :locals => { :meal_item_form => meal_item_form } %>
            <% end %>
          </tbody>
        </table>
        
        <div id="add-meal-item" class="button" style="float: right; width: 162px;">Add This To The Meal</div>
        <div class="clear"></div>
      </div>
      
      <div style="padding: 15px;">
        <br/>
        
        <%= text_field_tag "meal[ate_on]", ate_on_start_date, :id => "calendar-box" %>
        
        <div id="selected-date-help"><span class="bold">Was the date of the meal today?</span> Feel free to edit the date of this meal.</div>
        
        <div class="clear"></div>
        <br/>
        
        <p>
          <%= meal_form.label :time_of_day, 'Meal Time' %><br/>
          <%= meal_form.time_select :time_of_day, :twelve_hour => true %>
        </p>
        
        <p>
          <%= meal_form.label :meal_type %><br/>
          <%= meal_form.select :meal_type, options_for_select(Meal::TYPES) %>
        </p>
        
        <p>
          <%= meal_form.label :note, 'Meal Note' %><br/>
          <%= meal_form.text_area :note %>
        </p>
        
        <p>
          <%= meal_form.submit @meal.new_record? ? "Save This Meal" : "Update This Meal" %>
        </p>
      </div>
    <% end %>
  </div>
  
  <div class="grid_4">
    &nbsp;
    
  </div>

</div>

<script type="text/javascript" charset="utf-8">
  <% content_for :js do %>
    $('#food-item-entry').labelify({ labelledClass: "labelHighlight" });
    $('#calendar-box').datepicker();
    
    $('#food-item-entry').autocomplete({
      source: "/foods/search",
      minLength: 2,
      select: function(evt, ui){
        $("#food_id").val(ui.item.id);
      }
    });
    
    $("#add-meal-item").click(function(evt){
      var form = $("form#meal-new-item");
      
      if($("#quantity-whole-entry").val() == "0" && $("#quantity-part-entry").val() == "0"){
        alert("Please select a serving amount and measure before adding");
      }else{
        $.post("<%= meal_item_meals_path() %>", form.serialize() )
      }
      
      return false;
    });
    
    $(".remove_ajax_meal_item").live('click', function(evt){
      evt.preventDefault();
      $(this).closest('tr').detach();
    });
  <% end %>
</script>